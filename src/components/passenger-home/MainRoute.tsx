import React, {memo, useCallback, useMemo, useRef} from 'react';
import {Pressable, StyleSheet, View} from 'react-native';
import {DateData} from 'react-native-calendars';
import {Icons} from '~/assets/svgs';
import {MyDriverModel} from '~/model/driver-model';
import WorkdayCalendarModal, {
  WorkdayCalendarModalRefs,
} from '~components/calendar/workday-calendar-modal';
import CustomButton from '~components/commons/custom-button';
import ToastMessageController from '~components/commons/toast-message/toast-message-controller';
import CustomText from '~components/custom-text';
import HStack from '~components/h-stack';
import {PADDING, WIDTH} from '~constants/constant'; // PADDING1 Ï∂îÍ∞Ä
import {FONT, FONT_FAMILY} from '~constants/enum';
import {ROUTE_KEY} from '~navigators/router';
import {UseRootStackNavigation} from '~navigators/stack';
import {cachePassengerFilter} from '~reducers/carpoolReducer';
import {clearTemporaryRoute} from '~reducers/userReducer';
import {useAppDispatch, useAppSelector} from '~store/storeHooks';
import {colors} from '~styles/colors';
import {heightScale1, scale1, widthScale1} from '~styles/scaling-utils'; // heightScale Ï∂îÍ∞Ä
import {dayjs} from '~utils/dayjsUtil';
import {getDayName} from '~utils/hourUtils';
import {useNavigation} from '@react-navigation/native'; // useNavigation Ï∂îÍ∞Ä

interface Props {
  myRoadInfo?: MyDriverModel;
}

const MainRoute: React.FC<Props> = memo(props => {
  const {myRoadInfo} = props;
  const navigation = useNavigation<UseRootStackNavigation>();
  const dispatch = useAppDispatch();

  const currentPassengerModeFilter = useAppSelector(
    state => state?.carpoolReducer?.passengerModeFilter,
  );
  const selectedDay = currentPassengerModeFilter?.selectedDay;
  const transactionType = useAppSelector(
    state => state?.carpoolReducer?.passengerModeFilter?.carInOut,
  );
  const temporaryRoute = useAppSelector(state => state.userReducer.temporaryRoute);

  const calendarRef = useRef<WorkdayCalendarModalRefs>(null);

  const isWayHome = useMemo(() => transactionType === 'out', [transactionType]);

  const textStart = useMemo(() => {
    const startPlaceOut = temporaryRoute?.startPlaceOut || myRoadInfo?.startPlaceOut;
    const startPlaceIn = temporaryRoute?.startPlaceIn || myRoadInfo?.startPlaceIn;
    return isWayHome ? startPlaceOut : startPlaceIn;
  }, [isWayHome, temporaryRoute, myRoadInfo]);

  const textEnd = useMemo(() => {
    const endPlaceOut = temporaryRoute?.endPlaceOut || myRoadInfo?.endPlaceOut;
    const endPlaceIn = temporaryRoute?.endPlaceIn || myRoadInfo?.endPlaceIn;
    return isWayHome ? endPlaceOut : endPlaceIn;
  }, [isWayHome, temporaryRoute, myRoadInfo]);

  const onShowCalendar = () => {
    if (!currentPassengerModeFilter?.routeRegistrationComplete) {
      ToastMessageController.show(
        'Î™®Îì† ÎìúÎùºÏù¥Î≤Ñ ÏÑ†ÌÉùÏãú Í∏∞Í∞Ñ ÏÑ§Ï†ïÏù¥ Ï†úÌïúÎê©ÎãàÎã§.\nÎì±Î°ù ÏôÑÎ£åÎ°ú ÌïÑÌÑ∞ÎßÅ Í∞íÏùÑ Î≥ÄÍ≤ΩÌïú ÌõÑÏóêÎäî\nÍ∏∞Í∞ÑÏùÑ ÏÑ§Ï†ïÌï† Ïàò ÏûàÏäµÎãàÎã§.',
      );
      return;
    }
    calendarRef?.current?.show(selectedDay);
  };

  const getRouteDefault = useCallback(() => {
    // useCallbackÏúºÎ°ú Í∞êÏã∏Í∏∞
    dispatch(clearTemporaryRoute());
  }, [dispatch]);

  const getDayFilterText = useMemo((): string => {
    const currentDate: DateData = {
      dateString: dayjs().format('YYYY-MM-DD'),
      month: Number(dayjs().format('MM')),
      day: Number(dayjs().format('DD')),
      year: Number(dayjs().format('YYYY')),
      timestamp: Number(dayjs().valueOf()),
    };

    const maxDate = dayjs().add(13, 'day'); // subtract(-13) -> add(13)
    const maxDateObj: DateData = {
      dateString: maxDate.format('YYYY-MM-DD'),
      month: Number(maxDate.format('MM')),
      day: Number(maxDate.format('DD')),
      year: Number(maxDate.format('YYYY')),
      timestamp: Number(maxDate.valueOf()),
    };

    if (selectedDay && selectedDay?.length === 1) {
      const retunredDay =
        dayjs(selectedDay[0]?.dateString, 'YYYY-MM-DD').format('MMÏõîDDÏùº') +
        `(${getDayName(dayjs(selectedDay[0]?.dateString, 'YYYY-MM-DD').valueOf())})`;
      return retunredDay;
    }

    if (selectedDay && selectedDay?.length === 2) {
      const checkCurrentDay = selectedDay[0]?.dateString === currentDate?.dateString;
      const checkMaxDay = selectedDay[1]?.dateString === maxDateObj?.dateString;
      if (checkCurrentDay && checkMaxDay) {
        return 'Ï†ÑÏ≤¥Í∏∞Í∞Ñ';
      }

      const diffDate = dayjs(selectedDay?.[1].timestamp).diff(selectedDay?.[0].timestamp, 'day');
      if (diffDate > 13) {
        // 'Ï†ÑÏ≤¥Í∏∞Í∞Ñ' Ï°∞Í±¥ Ïö∞ÏÑ†
        return 'Ï†ÑÏ≤¥Í∏∞Í∞Ñ';
      } else {
        const retunredFirstDay =
          dayjs(selectedDay[0]?.dateString, 'YYYY-MM-DD').format('MMÏõîDDÏùº') +
          `(${getDayName(dayjs(selectedDay[0]?.dateString, 'YYYY-MM-DD').valueOf())})`;
        const retunredSecondDay =
          dayjs(selectedDay[1]?.dateString, 'YYYY-MM-DD').format('MMÏõîDDÏùº') +
          `(${getDayName(dayjs(selectedDay[1]?.dateString, 'YYYY-MM-DD').valueOf())})`;
        return `${retunredFirstDay}\n~${retunredSecondDay}`;
      }
    }
    return 'Ï†ÑÏ≤¥Í∏∞Í∞Ñ';
  }, [selectedDay, currentPassengerModeFilter]);

  const getButtonType = useMemo(() => {
    const commonButtonStyle = {
      borderRadius: 999,
      paddingHorizontal: widthScale1(14),
    };
    let isActive = false;

    if (isWayHome) {
      isActive = !temporaryRoute?.endCoordOut || !temporaryRoute?.startCoordOut;
    } else {
      isActive = !temporaryRoute?.endCoordIn || !temporaryRoute?.startCoordIn;
    }

    return (
      <CustomButton
        text="ÎÇ¥Í≤ΩÎ°ú"
        onPress={getRouteDefault}
        buttonHeight={32}
        textSize={FONT.CAPTION_6}
        buttonStyle={commonButtonStyle}
        type={isActive ? undefined : 'TERTIARY'} // Í∏∞Î≥∏ ÌÉÄÏûÖÏùÑ undefinedÎ°ú ÏÑ§Ï†ï
        outLine={!isActive}
      />
    );
  }, [temporaryRoute, isWayHome, getRouteDefault]);

  return (
    // üëá Î©îÏù∏ Ïª®ÌÖåÏù¥ÎÑà Í∑∏Î¶ºÏûê Íµ¨Ï°∞ ÏàòÏ†ï
    <View style={styles.shadowWrapper}>
      <View style={styles.contentWrapper}>
        <HStack style={styles.contentContainerStyle}>
          <Pressable onPress={onShowCalendar}>
            <HStack style={{gap: widthScale1(6)}}>
              <CustomText
                string={getDayFilterText}
                family={FONT_FAMILY.SEMI_BOLD}
                color={colors.heavyGray}
                forDriveMe
                lineHeight={20}
                numberOfLines={2} // Ïó¨Îü¨ Ï§Ñ ÌëúÏãú ÌóàÏö©
                textStyle={{textAlign: 'left'}} // ÌÖçÏä§Ìä∏ Ï†ïÎ†¨
              />
              <Icons.ChevronDown />
            </HStack>
          </Pressable>

          <HStack style={styles.buttonGroupWrapperStyle}>
            {/* üëá Ï∂úÍ∑ºÍ∏∏ Î≤ÑÌäº Í∑∏Î¶ºÏûê Íµ¨Ï°∞ ÏàòÏ†ï */}
            <View style={!isWayHome ? styles.activeButtonShadowWrapper : {}}>
              <Pressable
                onPress={() => {
                  dispatch(
                    cachePassengerFilter({
                      ...currentPassengerModeFilter,
                      carInOut: 'in',
                    }),
                  );
                }}
                style={[
                  styles.buttonStyle,
                  {backgroundColor: !isWayHome ? colors.white : colors.transparent},
                ]}>
                <CustomText
                  size={FONT.CAPTION_6}
                  forDriveMe
                  color={!isWayHome ? colors.black : colors.disableButton}
                  string={'Ï∂úÍ∑ºÍ∏∏'}
                  family={!isWayHome ? FONT_FAMILY.SEMI_BOLD : FONT_FAMILY.MEDIUM}
                />
              </Pressable>
            </View>
            {/* üëá Ìá¥Í∑ºÍ∏∏ Î≤ÑÌäº Í∑∏Î¶ºÏûê Íµ¨Ï°∞ ÏàòÏ†ï */}
            <View style={isWayHome ? styles.activeButtonShadowWrapper : {}}>
              <Pressable
                onPress={() => {
                  dispatch(
                    cachePassengerFilter({
                      ...currentPassengerModeFilter,
                      carInOut: 'out',
                    }),
                  );
                }}
                style={[
                  styles.buttonStyle,
                  {backgroundColor: isWayHome ? colors.white : colors.transparent},
                ]}>
                <CustomText
                  size={FONT.CAPTION_6}
                  forDriveMe
                  color={isWayHome ? colors.black : colors.disableButton}
                  string={'Ìá¥Í∑ºÍ∏∏'}
                  family={isWayHome ? FONT_FAMILY.SEMI_BOLD : FONT_FAMILY.MEDIUM}
                />
              </Pressable>
            </View>
          </HStack>
        </HStack>

        <HStack style={{justifyContent: 'space-between'}}>
          <Pressable
            onPress={() => {
              navigation.navigate(ROUTE_KEY.WayToWorkRegistration2, {
                textSearchFromValue: textStart,
                textSearchToValue: textEnd,
                isReturnRoute: isWayHome,
                focusTo: false,
              });
            }}
            style={styles.viewWrapperStyle}>
            <CustomText
              lineHeight={heightScale1(20)}
              numberOfLines={1}
              size={FONT.CAPTION_6}
              family={FONT_FAMILY.REGULAR}
              forDriveMe
              color={colors.black}
              string={textStart!}
            />
          </Pressable>

          <Icons.ChevronRight width={scale1(16)} height={scale1(16)} />

          <Pressable
            onPress={() => {
              navigation.navigate(ROUTE_KEY.WayToWorkRegistration2, {
                textSearchFromValue: textStart,
                textSearchToValue: textEnd,
                isReturnRoute: isWayHome,
                focusTo: true,
              });
            }}
            style={styles.viewWrapperStyle}>
            <CustomText
              lineHeight={heightScale1(20)}
              numberOfLines={1}
              size={FONT.CAPTION_6}
              family={FONT_FAMILY.REGULAR}
              forDriveMe
              color={colors.black}
              string={textEnd!}
            />
          </Pressable>

          {getButtonType}
        </HStack>

        <WorkdayCalendarModal ref={calendarRef} />
      </View>
    </View>
  );
});

export default MainRoute;

const styles = StyleSheet.create({
  // Î©îÏù∏ Ïª®ÌÖåÏù¥ÎÑàÏùò Í∑∏Î¶ºÏûêÎ•º Îã¥Îãπ
  shadowWrapper: {
    marginHorizontal: PADDING,
    width: WIDTH - PADDING * 2,
    shadowColor: colors.shadowColor,
    shadowOffset: {width: 0, height: 4},
    shadowRadius: 4,
    shadowOpacity: 0.1,
    elevation: 10,
    // borderRadius: scale1(8), // Í∑∏Î¶ºÏûê Ïª®ÌÖåÏù¥ÎÑàÏóêÎèÑ borderRadiusÎ•º Ï£ºÎ©¥ Í∑∏Î¶ºÏûêÍ∞Ä Îçî ÏûêÏó∞Ïä§Îü¨Ïö∏ Ïàò ÏûàÏäµÎãàÎã§.
  },
  // Î©îÏù∏ Ïª®ÌÖåÏù¥ÎÑàÏùò Ïã§Ï†ú ÎÇ¥Ïö©(Î∞∞Í≤Ω, Ìå®Îî© Îì±)ÏùÑ Îã¥Îãπ
  contentWrapper: {
    backgroundColor: colors.white,
    paddingHorizontal: PADDING,
    paddingVertical: heightScale1(12),
    borderRadius: scale1(8),
    overflow: 'hidden', // ÎÇ¥Î∂Ä ÏöîÏÜåÍ∞Ä borderRadiusÎ•º Î≤óÏñ¥ÎÇòÏßÄ ÏïäÎèÑÎ°ù
  },
  contentContainerStyle: {
    justifyContent: 'space-between',
    marginBottom: heightScale1(20),
  },
  // timeTextWrapperStyle, timeTextStyleÎäî getDayFilterTextÏóêÏÑú CustomTextÏùò propsÎ°ú ÏßÅÏ†ë Í¥ÄÎ¶¨
  buttonGroupWrapperStyle: {
    backgroundColor: colors.policy,
    padding: widthScale1(4),
    borderRadius: 999,
    overflow: 'hidden', // ÎÇ¥Î∂Ä Î≤ÑÌäºÏù¥ Î∂ÄÎ™®Ïùò borderRadiusÎ•º Îî∞Î•¥ÎèÑÎ°ù
  },
  // Ï∂úÌá¥Í∑º Î≤ÑÌäºÏùò Í∑∏Î¶ºÏûêÎ•º Îã¥Îãπ (ÌôúÏÑ±ÌôîÎê† ÎïåÎßå Ï†ÅÏö©)
  activeButtonShadowWrapper: {
    shadowColor: colors.shadowColor,
    shadowOffset: {width: 0, height: 1}, // Í∑∏Î¶ºÏûê ÎØ∏ÏÑ∏ Ï°∞Ï†ï
    shadowOpacity: 0.08, // Í∑∏Î¶ºÏûê ÎØ∏ÏÑ∏ Ï°∞Ï†ï
    shadowRadius: 5, // Í∑∏Î¶ºÏûê ÎØ∏ÏÑ∏ Ï°∞Ï†ï
    elevation: 5, // Í∑∏Î¶ºÏûê ÎØ∏ÏÑ∏ Ï°∞Ï†ï
    borderRadius: 999, // Í∑∏Î¶ºÏûê Î™®ÏñëÏùÑ ÏúÑÌï¥ PressableÍ≥º ÎèôÏùºÌïòÍ≤å
  },
  buttonStyle: {
    minWidth: widthScale1(76),
    minHeight: heightScale1(30),
    alignItems: 'center',
    justifyContent: 'center',
    borderRadius: 999,
    paddingHorizontal: widthScale1(5), // ÌÖçÏä§Ìä∏Í∞Ä ÏûòÎ¶¨ÏßÄ ÏïäÎèÑÎ°ù ÏïΩÍ∞ÑÏùò Ìå®Îî© Ï∂îÍ∞Ä
  },
  // buttonTextStyleÏùÄ CustomText propsÎ°ú ÏßÅÏ†ë Í¥ÄÎ¶¨
  viewWrapperStyle: {
    width: widthScale1(100),
  },
  // addressTextStyleÏùÄ CustomText propsÎ°ú ÏßÅÏ†ë Í¥ÄÎ¶¨
});
